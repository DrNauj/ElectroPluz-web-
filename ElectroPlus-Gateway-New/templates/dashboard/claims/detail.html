{% extends "dashboard/base.html" %}
{% load static %}

{% block content %}
{% csrf_token %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Reclamo #{{ claim.id }}</h1>
        <div class="btn-group">
            {% if perms.storefront.change_claim %}
            <button type="button" 
                    class="btn btn-outline-primary"
                    onclick="updateClaimStatus({{ claim.id }})">
                <i class="bi bi-arrow-clockwise"></i> Actualizar Estado
            </button>
            {% endif %}
            <a href="{% url 'dashboard:claims_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Detalles del Reclamo -->
        <div class="col-md-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información del Reclamo</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Estado:</dt>
                        <dd class="col-sm-8">
                            {% if claim.status == 'pending' %}
                            <span class="badge bg-warning">Pendiente</span>
                            {% elif claim.status == 'in_progress' %}
                            <span class="badge bg-info">En Proceso</span>
                            {% elif claim.status == 'resolved' %}
                            <span class="badge bg-success">Resuelto</span>
                            {% elif claim.status == 'rejected' %}
                            <span class="badge bg-danger">Rechazado</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Tipo:</dt>
                        <dd class="col-sm-8">
                            {% if claim.type == 'product_issue' %}
                            <span class="badge bg-warning">Problema con producto</span>
                            {% elif claim.type == 'shipping_issue' %}
                            <span class="badge bg-info">Problema de envío</span>
                            {% elif claim.type == 'wrong_product' %}
                            <span class="badge bg-danger">Producto equivocado</span>
                            {% elif claim.type == 'other' %}
                            <span class="badge bg-secondary">Otro</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Fecha:</dt>
                        <dd class="col-sm-8">{{ claim.created_at|date:"d/m/Y H:i" }}</dd>
                        
                        <dt class="col-sm-4">Última actualización:</dt>
                        <dd class="col-sm-8">{{ claim.updated_at|date:"d/m/Y H:i" }}</dd>
                        
                        <dt class="col-sm-4">Pedido relacionado:</dt>
                        <dd class="col-sm-8">
                            <a href="{% url 'dashboard:order_detail' claim.order.id %}">
                                #{{ claim.order.id }}
                            </a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Información del Cliente -->
        <div class="col-md-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información del Cliente</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Nombre:</dt>
                        <dd class="col-sm-8">{{ claim.order.user.get_full_name }}</dd>
                        
                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8">{{ claim.order.user.email }}</dd>
                        
                        <dt class="col-sm-4">Teléfono:</dt>
                        <dd class="col-sm-8">{{ claim.order.shipping_phone }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Descripción del Reclamo -->
    <div class="card dashboard-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Descripción del Reclamo</h5>
        </div>
        <div class="card-body">
            <p class="mb-0">{{ claim.description|linebreaks }}</p>
        </div>
    </div>

    <!-- Historial de Actualizaciones -->
    <div class="card dashboard-card">
        <div class="card-header">
            <h5 class="card-title mb-0">Historial de Actualizaciones</h5>
        </div>
        <div class="card-body">
            {% for update in claim.updates.all %}
            <div class="border-bottom mb-3 pb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>{{ update.user.get_full_name }}</strong>
                        <small class="text-muted">{{ update.created_at|date:"d/m/Y H:i" }}</small>
                    </div>
                    <span class="badge bg-secondary">{{ update.get_status_display }}</span>
                </div>
                <p class="mb-0 mt-2">{{ update.comment }}</p>
            </div>
            {% empty %}
            <p class="text-muted mb-0">No hay actualizaciones registradas.</p>
            {% endfor %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function updateClaimStatus(claimId) {
    const newStatus = prompt('Ingrese el nuevo estado (pending/in_progress/resolved/rejected):');
    const comment = prompt('Ingrese un comentario sobre el cambio de estado:');
    
    if (newStatus && comment) {
        const formData = new FormData();
        formData.append('status', newStatus);
        formData.append('comment', comment);
        
        fetch(`/dashboard/reclamos/${claimId}/actualizar-estado/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al actualizar el estado');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error al actualizar el estado');
            }
        })
        .catch(error => {
            alert(error.message);
        });
    }
}
</script>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
{% endblock %}