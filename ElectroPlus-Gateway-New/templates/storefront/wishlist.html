{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Lista de Deseos - ElectroPlus{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Mi Lista de Deseos</h2>

    {% if wishlist %}
        <div class="row row-cols-1 row-cols-md-3 g-4">
            {% for item in wishlist %}
            <div class="col">
                <div class="card h-100">
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" class="card-img-top" alt="{{ item.product.name }}">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ item.product.name }}</h5>
                        <p class="card-text">{{ item.product.description|truncatechars:100 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0">S/. {{ item.product.price }}</span>
                            <div class="btn-group">
                                <a href="{% url 'storefront:product_detail' item.product.slug %}" class="btn btn-sm btn-outline-secondary">Ver Detalles</a>
                                <button class="btn btn-sm btn-outline-danger remove-from-wishlist" data-product-id="{{ item.product.id }}">
                                    <i class="bi bi-heart-fill"></i> Quitar
                                </button>
                            </div>
                        </div>
                        {% if item.product.stock > 0 %}
                        <button class="btn btn-primary w-100 mt-2 add-to-cart" data-product-id="{{ item.product.id }}">
                            Agregar al Carrito
                        </button>
                        {% else %}
                        <button class="btn btn-secondary w-100 mt-2" disabled>
                            Sin Stock
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% bootstrap_pagination wishlist %}
        
    {% else %}
        <div class="alert alert-info">
            Tu lista de deseos está vacía. 
            <a href="{% url 'storefront:product_list' %}" class="alert-link">Explora nuestros productos</a>
        </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
// Remover de la lista de deseos
document.querySelectorAll('.remove-from-wishlist').forEach(button => {
    button.addEventListener('click', async function() {
        const productId = this.dataset.productId;
        const card = this.closest('.col');
        
        try {
            const response = await fetch(`/api/wishlist/${productId}/remove/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                card.remove();
                if (document.querySelectorAll('.col').length === 0) {
                    window.location.reload();
                }
            }
        } catch (error) {
            alert('Error al remover el producto de la lista de deseos.');
        }
    });
});

// Agregar al carrito
document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', async function() {
        const productId = this.dataset.productId;
        
        try {
            const response = await fetch('/api/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: 1
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Actualizar el contador del carrito en la barra de navegación
                const cartBadge = document.querySelector('#cart-badge');
                if (cartBadge) {
                    cartBadge.textContent = data.cart_count;
                }
                
                // Notificar al usuario
                alert('Producto agregado al carrito exitosamente.');
            } else {
                alert(data.message || 'No se pudo agregar el producto al carrito.');
            }
        } catch (error) {
            alert('Error al agregar el producto al carrito.');
        }
    });
});
</script>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
{% endblock %}