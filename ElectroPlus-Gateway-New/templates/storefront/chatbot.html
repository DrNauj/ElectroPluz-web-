{% extends 'base.html' %}
{% load static %}

{% block title %}Chatbot de Atención al Cliente - ElectroPlus{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-robot"></i> Asistente Virtual ElectroPlus
                    </h4>
                </div>
                <div class="card-body">
                    <div id="chat-messages" class="chat-messages mb-3" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background-color: #f8f9fa;">
                        <div class="message bot-message mb-3">
                            <div class="d-flex">
                                <div class="bot-avatar me-2">
                                    <i class="fas fa-robot text-primary"></i>
                                </div>
                                <div class="message-content">
                                    <div class="message-bubble bg-light p-2 rounded">
                                        ¡Hola! Soy el asistente virtual de ElectroPlus. ¿En qué puedo ayudarte hoy?
                                    </div>
                                        <small class="text-muted">{% now "H:i" %}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Escribe tu mensaje aquí..." maxlength="500">
                        <button class="btn btn-primary" type="button" id="send-button">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Pregúntame sobre productos, pedidos, envíos, devoluciones y más.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Quick suggestions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Preguntas frecuentes:</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-sm w-100 mb-2 quick-question" data-question="¿Cuáles son los tiempos de entrega?">
                                <i class="fas fa-truck"></i> Tiempos de entrega
                            </button>
                            <button class="btn btn-outline-primary btn-sm w-100 mb-2 quick-question" data-question="¿Cómo hago un pedido?">
                                <i class="fas fa-shopping-cart"></i> Cómo hacer pedido
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-sm w-100 mb-2 quick-question" data-question="¿Aceptan devoluciones?">
                                <i class="fas fa-undo"></i> Devoluciones
                            </button>
                            <button class="btn btn-outline-primary btn-sm w-100 mb-2 quick-question" data-question="¿Dónde están ubicados?">
                                <i class="fas fa-map-marker-alt"></i> Ubicación
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    scroll-behavior: smooth;
}

.message-bubble {
    max-width: 80%;
    word-wrap: break-word;
}

.bot-avatar {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #e9ecef;
    border-radius: 50%;
}

.user-message {
    justify-content: flex-end;
}

.user-message .message-bubble {
    background-color: #007bff;
    color: white;
    /* Ensanchar la burbuja de usuario y mejorar legibilidad */
    max-width: 90%;
    padding: 0.75rem 1rem;
    word-break: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 1rem;
}

.message-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.user-message .message-content {
    align-items: flex-end;
}

.typing-indicator {
    display: none;
    font-style: italic;
    color: #6c757d;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    // Obtener CSRF desde cookie para evitar depender de un <form> en la plantilla
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrfToken = getCookie('csrftoken');

    // Función para enviar mensaje
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Agregar mensaje del usuario
        addMessage(message, 'user');
        messageInput.value = '';

        // Mostrar indicador de escritura (si no existe)
        showTypingIndicator();

        // Desactivar botón para evitar envíos duplicados
        sendButton.disabled = true;

        // Enviar mensaje al servidor usando URL dinámica
        fetch('{% url "storefront:chatbot_response" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => {
            if (!response.ok) {
                // Intentar leer JSON con mensaje de error si existe
                return response.json().then(err => { throw { status: response.status, body: err }; });
            }
            return response.json();
        })
        .then(data => {
            hideTypingIndicator();
            if (data.response) {
                addMessage(data.response, 'bot');
            } else {
                addMessage('Lo siento, hubo un error. Inténtalo de nuevo.', 'bot');
            }
        })
        .catch(error => {
            hideTypingIndicator();
            console.error('Error:', error);
            addMessage('Lo siento, hubo un error de conexión. Inténtalo de nuevo.', 'bot');
        })
        .finally(() => {
            sendButton.disabled = false;
        });
    }

    // Función para agregar mensaje al chat
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message mb-3`;

        const container = document.createElement('div');
        container.className = 'd-flex';
        if (sender === 'user') container.classList.add('justify-content-end');

        if (sender === 'bot') {
            const avatarWrap = document.createElement('div');
            avatarWrap.className = 'bot-avatar me-2';
            const icon = document.createElement('i');
            icon.className = 'fas fa-robot text-primary';
            avatarWrap.appendChild(icon);
            container.appendChild(avatarWrap);
        }

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const bubble = document.createElement('div');
        bubble.className = `message-bubble p-2 rounded ${sender === 'user' ? 'bg-primary text-white' : 'bg-light'}`;
        // Usar textContent para evitar XSS
        bubble.textContent = text;

        const time = document.createElement('small');
        time.className = 'text-muted';
        time.textContent = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});

        messageContent.appendChild(bubble);
        messageContent.appendChild(time);
        container.appendChild(messageContent);

        messageDiv.appendChild(container);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Función para mostrar indicador de escritura
    function showTypingIndicator() {
        // No crear si ya existe
        if (document.getElementById('typing-indicator')) return;

        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator mb-3';
        indicator.id = 'typing-indicator';

        const wrap = document.createElement('div');
        wrap.className = 'd-flex';

        const avatarWrap = document.createElement('div');
        avatarWrap.className = 'bot-avatar me-2';
        const icon = document.createElement('i');
        icon.className = 'fas fa-robot text-primary';
        avatarWrap.appendChild(icon);

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble bg-light p-2 rounded';
        bubble.textContent = 'Escribiendo...';

        messageContent.appendChild(bubble);
        wrap.appendChild(avatarWrap);
        wrap.appendChild(messageContent);

        indicator.appendChild(wrap);
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Función para ocultar indicador de escritura
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    // Event listeners
    sendButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // Quick questions
    document.querySelectorAll('.quick-question').forEach(button => {
        button.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            messageInput.value = question;
            sendMessage();
        });
    });
});
</script>
{% endblock %}
