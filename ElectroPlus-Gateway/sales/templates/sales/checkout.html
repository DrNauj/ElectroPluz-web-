{% extends "storefront/base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2>Checkout</h2>
            
            <div class="row">
                <!-- Formulario de Envío -->
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Información de Envío</h5>
                            <form id="shippingForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">Nombre</label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Apellidos</label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>

                                <div class="mb-3">
                                    <label for="address" class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="address" required>
                                </div>

                                <div class="row">
                                    <div class="col-md-5 mb-3">
                                        <label for="country" class="form-label">País</label>
                                        <select class="form-select" id="country" required>
                                            <option value="">Seleccionar...</option>
                                            <option value="MX">México</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="state" class="form-label">Estado</label>
                                        <select class="form-select" id="state" required>
                                            <option value="">Seleccionar...</option>
                                            <!-- Agregar estados dinámicamente -->
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="zip" class="form-label">Código Postal</label>
                                        <input type="text" class="form-control" id="zip" required>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Método de Pago -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Método de Pago</h5>
                            <form id="paymentForm">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" checked>
                                        <label class="form-check-label" for="creditCard">
                                            Tarjeta de Crédito
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="debitCard">
                                        <label class="form-check-label" for="debitCard">
                                            Tarjeta de Débito
                                        </label>
                                    </div>
                                </div>

                                <div id="cardDetails">
                                    <div class="mb-3">
                                        <label for="cardNumber" class="form-label">Número de Tarjeta</label>
                                        <input type="text" class="form-control" id="cardNumber" required>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="expDate" class="form-label">Fecha de Expiración</label>
                                            <input type="text" class="form-control" id="expDate" placeholder="MM/YY" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="cvv" class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" required>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Resumen del Pedido -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Resumen del Pedido</h5>
                            <div class="order-summary">
                                {% for item in cart_items %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span>{{ item.product.name }} x {{ item.quantity }}</span>
                                    <span>${{ item.total_price }}</span>
                                </div>
                                {% endfor %}
                                
                                <hr>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal</span>
                                    <span>${{ subtotal }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Envío</span>
                                    <span>${{ shipping_cost }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>IVA</span>
                                    <span>${{ tax }}</span>
                                </div>
                                
                                <hr>
                                
                                <div class="d-flex justify-content-between">
                                    <strong>Total</strong>
                                    <strong>${{ total }}</strong>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary w-100 mt-4" onclick="processOrder()">
                                Confirmar Pedido
                            </button>
                            
                            <a href="{% url 'sales:cart' %}" class="btn btn-outline-secondary w-100 mt-2">
                                Volver al Carrito
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function processOrder() {
    // Validar formularios
    const shippingForm = document.getElementById('shippingForm');
    const paymentForm = document.getElementById('paymentForm');
    
    if (!shippingForm.checkValidity() || !paymentForm.checkValidity()) {
        alert('Por favor, complete todos los campos requeridos.');
        return;
    }

    // Recopilar datos
    const orderData = {
        shipping: {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            address: document.getElementById('address').value,
            country: document.getElementById('country').value,
            state: document.getElementById('state').value,
            zip: document.getElementById('zip').value
        },
        payment: {
            method: document.querySelector('input[name="paymentMethod"]:checked').id,
            cardNumber: document.getElementById('cardNumber').value,
            expDate: document.getElementById('expDate').value,
            cvv: document.getElementById('cvv').value
        }
    };

    // Enviar orden
    fetch('/sales/process-order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url; // Redirigir a página de confirmación
        } else {
            alert('Error al procesar el pedido: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar el pedido. Por favor, intente nuevamente.');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Cargar estados cuando se selecciona un país
document.getElementById('country').addEventListener('change', function() {
    const country = this.value;
    const stateSelect = document.getElementById('state');
    
    if (country === 'MX') {
        // Lista de estados de México
        const estados = [
            'Aguascalientes', 'Baja California', 'Baja California Sur', 'Campeche',
            'Chiapas', 'Chihuahua', 'Coahuila', 'Colima', 'Ciudad de México',
            'Durango', 'Guanajuato', 'Guerrero', 'Hidalgo', 'Jalisco', 'México',
            'Michoacán', 'Morelos', 'Nayarit', 'Nuevo León', 'Oaxaca', 'Puebla',
            'Querétaro', 'Quintana Roo', 'San Luis Potosí', 'Sinaloa', 'Sonora',
            'Tabasco', 'Tamaulipas', 'Tlaxcala', 'Veracruz', 'Yucatán', 'Zacatecas'
        ];
        
        stateSelect.innerHTML = '<option value="">Seleccionar...</option>' +
            estados.map(estado => `<option value="${estado}">${estado}</option>`).join('');
    } else {
        stateSelect.innerHTML = '<option value="">Seleccionar...</option>';
    }
});
</script>
{% endblock %}