{% extends 'base/base.html' %}

{% block title %}Nueva Venta - ElectroPlus{% endblock %}

{% block header %}Nueva Venta{% endblock %}

{% block content %}
<div class="row">
    <!-- Formulario de venta -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form id="form-venta" method="POST">
                    {% csrf_token %}
                    
                    <!-- Datos del cliente -->
                    <div class="mb-3">
                        <label for="cliente" class="form-label">Cliente</label>
                        <select class="form-select" id="cliente" name="cliente" required>
                            <option value="">Seleccione un cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombres }} {{ cliente.apellidos }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Búsqueda de productos -->
                    <div class="mb-3">
                        <label class="form-label">Agregar Productos</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="buscar-producto" 
                                   placeholder="Buscar producto...">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="buscarProducto()">
                                Buscar
                            </button>
                        </div>
                        <div id="resultados-busqueda" class="list-group mt-2" style="display: none;">
                            <!-- Los resultados se insertarán aquí dinámicamente -->
                        </div>
                    </div>

                    <!-- Lista de productos seleccionados -->
                    <div class="table-responsive">
                        <table class="table" id="tabla-productos">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Precio</th>
                                    <th>Cantidad</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los productos se insertarán aquí dinámicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td><span id="total-venta">S/. 0.00</span></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Campos ocultos para enviar los datos -->
                    <input type="hidden" name="productos" id="productos-json">
                    
                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="limpiarFormulario()">
                            Limpiar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Realizar Venta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel lateral de información -->
    <div class="col-md-4">
        <!-- Stock disponible -->
        <div class="card mb-3">
            <div class="card-header">
                Stock Disponible
            </div>
            <div class="card-body">
                <div id="info-stock">
                    Seleccione un producto para ver su stock
                </div>
            </div>
        </div>

        <!-- Cupones disponibles -->
        <div class="card">
            <div class="card-header">
                Cupones Disponibles
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for cupon in cupones %}
                    <button type="button" class="list-group-item list-group-item-action"
                            onclick="aplicarCupon('{{ cupon.codigo }}')">
                        {{ cupon.codigo }} - 
                        {% if cupon.tipo_descuento == 'Porcentaje' %}
                        {{ cupon.valor }}% de descuento
                        {% else %}
                        S/. {{ cupon.valor }} de descuento
                        {% endif %}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let productosSeleccionados = [];

function buscarProducto() {
    const query = document.getElementById('buscar-producto').value;
    
    fetch(`/api/productos/buscar/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultados = document.getElementById('resultados-busqueda');
            resultados.innerHTML = '';
            resultados.style.display = 'block';
            
            data.productos.forEach(producto => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    ${producto.nombre} - S/. ${producto.precio}
                    <small class="text-muted">(Stock: ${producto.stock})</small>
                `;
                item.onclick = (e) => {
                    e.preventDefault();
                    seleccionarProducto(producto);
                    resultados.style.display = 'none';
                };
                resultados.appendChild(item);
            });
        });
}

function seleccionarProducto(producto) {
    // Verificar si el producto ya está en la lista
    if (productosSeleccionados.some(p => p.id === producto.id)) {
        alert('Este producto ya está en la lista');
        return;
    }

    // Agregar producto a la lista
    productosSeleccionados.push({
        id: producto.id,
        nombre: producto.nombre,
        precio: producto.precio,
        cantidad: 1,
        stock: producto.stock
    });

    actualizarTablaProductos();
}

function actualizarTablaProductos() {
    const tbody = document.querySelector('#tabla-productos tbody');
    tbody.innerHTML = '';
    let total = 0;

    productosSeleccionados.forEach((producto, index) => {
        const subtotal = producto.precio * producto.cantidad;
        total += subtotal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${producto.nombre}</td>
            <td>S/. ${producto.precio}</td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${producto.cantidad}" min="1" max="${producto.stock}"
                       onchange="actualizarCantidad(${index}, this.value)">
            </td>
            <td>S/. ${subtotal.toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-danger btn-sm"
                        onclick="eliminarProducto(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('total-venta').textContent = `S/. ${total.toFixed(2)}`;
    document.getElementById('productos-json').value = JSON.stringify(productosSeleccionados);
}

function actualizarCantidad(index, cantidad) {
    cantidad = parseInt(cantidad);
    if (cantidad < 1) cantidad = 1;
    if (cantidad > productosSeleccionados[index].stock) {
        cantidad = productosSeleccionados[index].stock;
        alert('No hay suficiente stock disponible');
    }
    productosSeleccionados[index].cantidad = cantidad;
    actualizarTablaProductos();
}

function eliminarProducto(index) {
    productosSeleccionados.splice(index, 1);
    actualizarTablaProductos();
}

function limpiarFormulario() {
    if (confirm('¿Está seguro de limpiar el formulario?')) {
        document.getElementById('cliente').value = '';
        productosSeleccionados = [];
        actualizarTablaProductos();
    }
}

function aplicarCupon(codigo) {
    fetch('/api/cupones/validar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            codigo: codigo,
            productos: productosSeleccionados
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`Cupón aplicado: ${data.descuento}`);
            // Actualizar el total con el descuento
            document.getElementById('total-venta').textContent = 
                `S/. ${data.nuevo_total.toFixed(2)}`;
        } else {
            alert(data.message);
        }
    });
}

// Al enviar el formulario
document.getElementById('form-venta').onsubmit = function(e) {
    e.preventDefault();
    
    if (productosSeleccionados.length === 0) {
        alert('Debe agregar al menos un producto');
        return;
    }

    if (!confirm('¿Está seguro de realizar esta venta?')) {
        return;
    }

    // Enviar formulario
    fetch('/api/ventas/realizar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            cliente: document.getElementById('cliente').value,
            productos: productosSeleccionados
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Venta realizada con éxito');
            window.location.href = `/ventas/${data.venta_id}/`;
        } else {
            alert(data.message);
        }
    });
};
</script>
{% endblock %}