{% extends 'base/dashboard_base.html' %}

{% block title %}Panel de Cliente{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <h1 class="h3 mb-4">Mi Panel</h1>
    
    {% if error %}
    <div class="alert alert-danger">
        {{ error }}
    </div>
    {% endif %}
    
    {% if customer_info %}
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Mi Información</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <p class="mb-0 font-weight-bold">Nombre:</p>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted mb-0">{{ customer_info.nombre }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-4">
                            <p class="mb-0 font-weight-bold">Email:</p>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted mb-0">{{ customer_info.email }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-4">
                            <p class="mb-0 font-weight-bold">Teléfono:</p>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted mb-0">{{ customer_info.telefono }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-4">
                            <p class="mb-0 font-weight-bold">Dirección:</p>
                        </div>
                        <div class="col-sm-8">
                            <p class="text-muted mb-0">{{ customer_info.direccion }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="window.location.href='{% url 'profile' %}'">
                            Editar Información
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Resumen de Compras</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total de Pedidos</h5>
                                    <p class="h3">{{ customer_info.total_pedidos }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Total Gastado</h5>
                                    <p class="h3">${{ customer_info.total_gastado|floatformat:2 }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if orders %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Mis Pedidos</h6>
                    <div class="dropdown no-arrow">
                        <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown">
                            Filtrar por Estado
                        </button>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in">
                            <a class="dropdown-item active" href="#" onclick="filterOrders('all')">Todos</a>
                            <a class="dropdown-item" href="#" onclick="filterOrders('pendiente')">Pendientes</a>
                            <a class="dropdown-item" href="#" onclick="filterOrders('enviado')">Enviados</a>
                            <a class="dropdown-item" href="#" onclick="filterOrders('entregado')">Entregados</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="ordersTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>ID Pedido</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr data-estado="{{ order.estado|lower }}">
                                    <td>{{ order.id }}</td>
                                    <td>{{ order.fecha|date:"d/m/Y H:i" }}</td>
                                    <td>${{ order.total|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge badge-{% if order.estado == 'Pendiente' %}warning{% elif order.estado == 'Enviado' %}info{% else %}success{% endif %}">
                                            {{ order.estado }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="viewOrderDetails({{ order.id }})">
                                            Ver Detalles
                                        </button>
                                        {% if order.estado == 'Pendiente' %}
                                        <button class="btn btn-sm btn-danger" onclick="cancelOrder({{ order.id }})">
                                            Cancelar
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para detalles del pedido -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Pedido</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="orderDetails">
                    <!-- Los detalles se cargarán dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewOrderDetails(orderId) {
    // Cargar detalles del pedido vía AJAX
    $.get(`/api/pedidos/${orderId}/`, function(data) {
        let detailsHtml = `
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.items.forEach(item => {
            detailsHtml += `
                <tr>
                    <td>${item.producto}</td>
                    <td>${item.cantidad}</td>
                    <td>$${item.precio_unitario}</td>
                    <td>$${(item.cantidad * item.precio_unitario).toFixed(2)}</td>
                </tr>
            `;
        });
        
        detailsHtml += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3">Total</th>
                            <th>$${data.total}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="mt-3">
                <h6>Estado del Pedido</h6>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: ${data.progreso}%" aria-valuenow="${data.progreso}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span>Pedido Realizado</span>
                    <span>En Proceso</span>
                    <span>Enviado</span>
                    <span>Entregado</span>
                </div>
            </div>
        `;
        
        $('#orderDetails').html(detailsHtml);
        $('#orderDetailsModal').modal('show');
    });
}

function cancelOrder(orderId) {
    if (confirm('¿Está seguro que desea cancelar este pedido?')) {
        $.post(`/api/pedidos/${orderId}/cancelar/`, function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert('No se pudo cancelar el pedido');
            }
        });
    }
}

function filterOrders(estado) {
    if (estado === 'all') {
        $('#ordersTable tbody tr').show();
    } else {
        $('#ordersTable tbody tr').hide();
        $(`#ordersTable tbody tr[data-estado="${estado}"]`).show();
    }
    
    $('.dropdown-item').removeClass('active');
    $(`.dropdown-item[onclick="filterOrders('${estado}')"]`).addClass('active');
}

$(document).ready(function() {
    $('#ordersTable').DataTable({
        order: [[1, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json'
        }
    });
});
</script>
{% endblock %}